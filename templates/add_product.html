{% extends "base.html" %}

{% block title %}Add Product - E-commerce{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Add Product</h1>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="alert alert-danger" id="alert-message">
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    <form method="POST" action="{{ url_for('main.add_product') }}" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="form-group">
            {{ form.name.label }}
            {{ form.name(class_="form-control") }}
            {% for error in form.name.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.description.label }}
            {{ form.description(class_="form-control") }}
            {% for error in form.description.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.price.label }}
            {{ form.price(class_="form-control") }}
            {% for error in form.price.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.quantity.label }}
            {{ form.quantity(class_="form-control") }}
            {% for error in form.quantity.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.brand_id.label }}
            <div class="input-group">
                {{ form.brand_id(class_="form-control", onchange="toggleNewBrandInput(this)") }}
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" onclick="createNewBrand()">+</button>
                </div>
            </div>
            {% for error in form.brand_id.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
            <div id="new_brand_name_group" style="display:none;">
                {{ form.new_brand_name.label }}
                {{ form.new_brand_name(class_="form-control") }}
                {% for error in form.new_brand_name.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            {{ form.category_id.label }}
            <div class="input-group">
                {{ form.category_id(class_="form-control", onchange="toggleNewCategoryInput(this)") }}
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" onclick="createNewCategory()">+</button>
                </div>
            </div>
            {% for error in form.category_id.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
            <div id="new_category_name_group" style="display:none;">
                {{ form.new_category_name.label }}
                {{ form.new_category_name(class_="form-control") }}
                {% for error in form.new_category_name.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            {{ form.image.label }}
            {{ form.image(class_="form-control") }}
            {% for error in form.image.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </div>

        <div class="mb-3">
            <img id="image-preview" src="https://drive.google.com/thumbnail?id=1tvBMvCFzeZ14Kcr7z3iZ0yS6QfQOCFzQ" alt="Image" class="img-thumbnail" width="100">
        </div>

        <button type="submit" class="btn btn-primary">Add Product</button>
    </form>
</div>
{% endblock %}

{% block custom_js %}
<script>
    function toggleNewBrandInput(select) {
        var newBrandGroup = document.getElementById('new_brand_name_group');
        if (select.value === '0') {
            newBrandGroup.style.display = 'block';
        } else {
            newBrandGroup.style.display = 'none';
        }
    }

    function toggleNewCategoryInput(select) {
        var newCategoryGroup = document.getElementById('new_category_name_group');
        if (select.value === '0') {
            newCategoryGroup.style.display = 'block';
        } else {
            newCategoryGroup.style.display = 'none';
        }
    }

    function createNewBrand() {
        var brandName = prompt("Enter new brand name:");
        if (brandName) {
            fetch("{{ url_for('main.create_brand') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token() }}"
                },
                body: JSON.stringify({ name: brandName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Brand created successfully!");
                    location.reload();
                } else {
                    alert("Error creating brand: " + data.error);
                }
            });
        }
    }

    function createNewCategory() {
        var categoryName = prompt("Enter new category name:");
        if (categoryName) {
            fetch("{{ url_for('main.create_category') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token() }}"
                },
                body: JSON.stringify({ name: categoryName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Category created successfully!");
                    location.reload();
                } else {
                    alert("Error creating category: " + data.error);
                }
            });
        }
    }

    function previewImage(input) {
        var file = input.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        var brandSelect = document.querySelector('select[name="brand_id"]');
        var categorySelect = document.querySelector('select[name="category_id"]');

        if (brandSelect) {
            brandSelect.addEventListener('change', function () {
                toggleNewBrandInput(this);
            });
        }

        if (categorySelect) {
            categorySelect.addEventListener('change', function () {
                toggleNewCategoryInput(this);
            });
        }
    });
</script>
{% endblock %}
